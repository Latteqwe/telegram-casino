<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üé∞ –ú–∏–Ω–∏-–ö–∞–∑–∏–Ω–æ</title>
  <style>
    body {
      margin: 0;
      background: #121212;
      color: #eee;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      user-select: none;
      -webkit-user-select: none;
      font-size: 1.5rem;
    }
    #balance {
      margin-top: 1rem;
      font-weight: 700;
      font-size: 1.8rem;
    }
    #result {
      margin: 1.5rem 0;
      font-size: 4rem;
      letter-spacing: 1rem;
      user-select: none;
    }
    #message {
      min-height: 2rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }
    button {
      cursor: pointer;
      font-size: 1.3rem;
      padding: 0.7rem 2rem;
      margin: 0.3rem;
      border: none;
      border-radius: 12px;
      background-color: #ff6f00;
      color: #222;
      font-weight: 700;
      transition: background-color 0.2s ease-in-out;
      user-select: none;
    }
    button:hover {
      background-color: #ffa726;
    }
  </style>
</head>
<body>

  <h1>üé∞ –ú–∏–Ω–∏-–ö–∞–∑–∏–Ω–æ</h1>
  <div id="balance">–ë–∞–ª–∞–Ω—Å: –∑–∞–≥—Ä—É–∑–∫–∞...</div>
  <div id="result">üçíüçãüçä</div>
  <div id="message"></div>
  <button id="spinBtn">–°–ü–ò–ù</button>
  <button id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å –∏–≥—Ä—É üîÑ</button>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    (function(){
      const symbols = ["üçí", "üçã", "üçä", "üçâ", "‚≠ê", "üíé"];
      const balanceDiv = document.getElementById('balance');
      const resultDiv = document.getElementById('result');
      const messageDiv = document.getElementById('message');
      const spinBtn = document.getElementById('spinBtn');
      const refreshBtn = document.getElementById('refreshBtn');

      let balance = 0;
      let volume = 0.3;

      const clickSound = new Audio("https://actions.google.com/sounds/v1/foley/coin_drop.ogg");
      clickSound.volume = volume;
      const winSound = new Audio("https://actions.google.com/sounds/v1/cartoon/concussive_hit_guitar_boing.ogg");
      winSound.volume = volume;

      Telegram.WebApp.ready();

      // –ó–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞ —É –±–æ—Ç–∞
      function requestBalance(){
        Telegram.WebApp.sendData(JSON.stringify({ action: "get_balance" }));
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
      function updateBalanceDisplay(value){
        balance = value;
        balanceDiv.textContent = `–ë–∞–ª–∞–Ω—Å: ${balance}üí∞`;
      }

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–ø–∏–Ω–∞
      function generateResult(){
        const chance = Math.random() * 100;
        let res = [];
        if(chance <= 1){
          const sym = symbols[Math.floor(Math.random() * symbols.length)];
          res = [sym, sym, sym];
        } else if(chance <= 21){
          const sym1 = symbols[Math.floor(Math.random() * symbols.length)];
          let sym2;
          do {
            sym2 = symbols[Math.floor(Math.random() * symbols.length)];
          } while(sym2 === sym1);
          res = Math.random() < 0.5 ? [sym1, sym1, sym2] : [sym1, sym2, sym1];
        } else {
          while(res.length < 3){
            const sym = symbols[Math.floor(Math.random() * symbols.length)];
            if(!res.includes(sym)) res.push(sym);
          }
        }
        return res;
      }

      // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤
      async function spinReel(col, finalSymbol){
        let speed = 50;
        const slowdownFactor = 1.08;
        while(speed < 300){
          let current = resultDiv.textContent.split('');
          current[col] = symbols[Math.floor(Math.random() * symbols.length)];
          resultDiv.textContent = current.join('');
          clickSound.currentTime = 0;
          clickSound.play().catch(() => {});
          await delay(speed);
          speed *= slowdownFactor;
        }
        let final = resultDiv.textContent.split('');
        final[col] = finalSymbol;
        resultDiv.textContent = final.join('');
      }

      // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
      function delay(ms){
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–∏–Ω–∞
      async function spin(){
        if(balance < 100){
          messageDiv.textContent = "‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è —Å–ø–∏–Ω–∞ (100üí∞)";
          return;
        }
        spinBtn.disabled = true;
        messageDiv.textContent = "";
        let results = generateResult();

        for(let col = 0; col < 3; col++){
          await spinReel(col, results[col]);
        }

        let msg = "";
        let change = -100; // —Å—Ç–∞–≤–∫–∞
        if(results[0] === results[1] && results[1] === results[2]){
          msg = "üéâ –î–∂–µ–∫–ø–æ—Ç!";
          change = 1000;
          winSound.play().catch(() => {});
        } else if(results[0] === results[1] || results[1] === results[2] || results[0] === results[2]){
          msg = "üòâ –ü–æ—á—Ç–∏!";
          change = 200;
        } else {
          msg = "üôÅ –ù–µ –ø–æ–≤–µ–∑–ª–æ!";
        }

        messageDiv.textContent = msg;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±–æ—Ç–∞
        Telegram.WebApp.sendData(JSON.stringify({
          action: "slot_result",
          result: results.join(''),
          change: change
        }));

        spinBtn.disabled = false;
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞ (—á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è)
      // –ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ event listener –≤ Telegram WebApp –¥–ª—è incoming data,
      // –±—É–¥–µ–º –ª–æ–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≤—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–ª—è—Ç—å –±–∞–ª–∞–Ω—Å.
      // –¢.–∫. –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ API –¥–ª—è —ç—Ç–æ–≥–æ, –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –ø—Ä–∏–¥—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å "–ë–∞–ª–∞–Ω—Å: N"
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –±–∞–ª–∞–Ω—Å –≤ —á–∞—Ç–µ.

      // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∞
      function refreshGame(){
        const url = new URL(window.location.href);
        url.searchParams.set('v', Date.now());
        window.location.href = url.toString();
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      spinBtn.addEventListener('click', spin);
      refreshBtn.addEventListener('click', refreshGame);

      requestBalance();

      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞, –µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ WebSocket –∏–ª–∏ polling,
      // –Ω–æ –ø–æ–∫–∞ Telegram –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –≤ WebApp –∫—Ä–æ–º–µ —á–µ—Ä–µ–∑ —á–∞—Ç.

    })();
  </script>

</body>
</html>
