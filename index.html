<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rofl Casino ‚Äî Mini App</title>
<link rel="icon" href="images/slot.png" />
<style>
:root{
  --bg-a: #031024; --bg-b: #061c36; --text: #cfe8ff;
  --panel-a: rgba(255,255,255,0.02); --panel-b: rgba(255,255,255,0.01);
  --panel-bg: rgba(3,16,28,0.52);
  --btn-a: #91b7e7; --btn-b: #2b5f91;
  --glow-color: rgba(140,170,223,0.46);
  --win-a: rgba(28,60,100,0.98); --win-b: rgba(6,20,34,0.96);
  --modal-a: rgba(6,12,22,0.98); --modal-b: rgba(8,18,32,0.98);
  --muted: #bfd9ff;
}
html,body{height:100%;margin:0;font-family:"Montserrat",Arial,sans-serif;background:linear-gradient(180deg,var(--bg-a),var(--bg-b));color:var(--text)}
body{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:18px 12px;box-sizing:border-box}
header{width:100%;max-width:960px;display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:18px}
#logo{width:48px}
h1{font-size:20px;margin:0;letter-spacing:1px;display:flex;align-items:center;gap:12px}
.stage{width:100%;max-width:960px;display:flex;flex-direction:column;align-items:center;gap:18px}
.panel{width:100%;border-radius:14px;padding:18px;box-sizing:border-box;background:linear-gradient(180deg,var(--panel-a),var(--panel-b));box-shadow:0 8px 30px rgba(1,19,38,0.5)}
.top-row{display:flex;width:100%;align-items:center;justify-content:space-between;gap:12px}
#balance{padding:10px 16px;border-radius:10px;background:var(--panel-bg);font-weight:700;box-shadow:0 3px 12px rgba(0,0,0,0.5)}
#message{flex:1;margin-left:12px;text-align:center;font-weight:600;min-height:22px;color:var(--text)}
.reel-wrap{position:relative;display:flex;align-items:center;justify-content:center;padding:18px;width:100%;max-width:960px;box-sizing:border-box;height:260px;overflow:visible}
@media (max-width:520px){ .reel-wrap{height:200px} #logo{width:38px} h1{font-size:16px} }
/* canvas won't block clicks now */
#reelsCanvas{display:block;background:transparent;position:absolute;left:0;top:0;will-change:transform;pointer-events:none;z-index:3}
.controls{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:8px;flex-wrap:wrap}
.action-button{padding:12px 18px;font-weight:800;border-radius:12px;border:none;cursor:pointer;background: linear-gradient(180deg,var(--btn-a),var(--btn-b));color:#031028;box-shadow: 0 8px 22px rgba(10,30,50,0.6);transition: box-shadow 180ms ease, transform 120ms ease;position:relative;}
@keyframes breath {0% { transform: translateY(0) scale(1); box-shadow: 0 14px 32px rgba(20,60,100,0.20), 0 0 12px var(--glow-color);}50% { transform: translateY(-2px) scale(1.03); box-shadow: 0 28px 56px rgba(20,60,100,0.30), 0 0 28px var(--glow-color);}100%{transform:translateY(0) scale(1);box-shadow:0 14px 32px rgba(20,60,100,0.20),0 0 12px var(--glow-color)}}
.action-button.breathing { animation: breath 2600ms ease-in-out infinite; }
.action-button:hover { transform: translateY(-2px); box-shadow: 0 28px 56px rgba(20,60,100,0.28), 0 0 28px var(--glow-color); }
.action-button:active { transform: translateY(0); box-shadow: 0 16px 38px rgba(20,60,100,0.20), 0 0 12px var(--glow-color); }
.action-button:disabled{opacity:0.6;cursor:not-allowed;animation:none}
.muted{opacity:0.85;font-size:14px;color:var(--muted)}
.stake-row{display:flex;gap:8px;align-items:center}
.stake-row input[type="number"]{width:110px;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:var(--text)}
.quick-stakes{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:8px}
.quick-stakes button{padding:8px 10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:var(--text);cursor:pointer}
.settings-btn{padding:8px 10px;border-radius:8px;border:none;background:linear-gradient(180deg,var(--btn-a),var(--btn-b));color:#031028;cursor:pointer;margin-left:6px}
.modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:999;backdrop-filter: blur(4px)}
.modal-panel{width:92%;max-width:720px;background:linear-gradient(180deg,var(--modal-a),var(--modal-b));padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.6);color:var(--text)}
.row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
.row:last-child{border-bottom:none}
.row .left{display:flex;align-items:center;gap:12px}
.row label{font-weight:700}
.slider{width:200px}
.theme-options{display:flex;gap:10px}
.theme-box{
  width:86px;height:56px;border-radius:8px;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.3);
  display:flex;align-items:center;justify-content:center;font-size:12px;
  text-align:center;padding:6px;box-sizing:border-box;font-weight:700;
}
.inline-btn{padding:6px 8px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:var(--text);cursor:pointer}
</style>
</head>
<body>
  <header>
    <img id="logo" src="images/slot.png" alt="Rofl" />
    <h1>Rofl Casino</h1>
  </header>

  <main class="stage">
    <section class="panel">
      <div class="top-row">
        <div id="balance">–ë–∞–ª–∞–Ω—Å: <span id="balValue">1000</span> üí∞</div>
        <div id="message" class="muted">–ì–æ—Ç–æ–≤–æ ‚Äî –Ω–∞–∂–º–∏ SPIN</div>
      </div>

      <div class="reel-wrap" id="reelArea" style="margin-top:14px;">
        <canvas id="reelsCanvas" width="800" height="260"></canvas>
      </div>

      <div class="controls" style="margin-top:14px;">
        <div class="stake-row">
          <label style="font-weight:700;color:var(--text)">–°—Ç–∞–≤–∫–∞:</label>
          <input id="stakeInput" type="number" min="10" step="10" value="100" />
          <div class="quick-stakes">
            <button type="button" class="inline-btn" data-step="-100">-100</button>
            <button type="button" class="inline-btn" data-step="-50">-50</button>
            <button type="button" class="inline-btn" data-step="+50">+50</button>
            <button type="button" class="inline-btn" data-step="+100">+100</button>
            <button type="button" class="inline-btn" id="maxStakeBtn" data-step="max">–ú–ê–ö–°</button>
          </div>
        </div>

        <button id="spinBtn" class="action-button breathing">–ö–†–£–¢–ò!</button>
        <button id="openSettings" class="action-button settings-btn">‚öô</button>
        <button class="inline-btn" id="autoSpinBtn" type="button">Auto: Off</button>
      </div>
    </section>
  </main>

  <!-- sounds -->
  <audio id="clickSound" src="sounds/click.mp3" preload="auto"></audio>
  <audio id="winSound" src="sounds/win.mp3" preload="auto"></audio>
  <audio id="loseSound" src="sounds/lose.mp3" preload="auto"></audio>
  <audio id="jackpotSound" src="sounds/jackpot.mp3" preload="auto"></audio>
  <audio id="bgMusic" src="sounds/bg.mp3" preload="auto" loop></audio>

  <div id="settingsModal" class="modal" style="display:none">
    <div class="modal-panel">
      <h3 style="margin:0 0 12px 0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div class="row">
        <div class="left"><label>–ú—É–∑—ã–∫–∞</label></div>
        <div>
          <input type="checkbox" id="musicToggle"> –í–∫–ª
          <input type="range" id="musicVolume" class="slider" min="0" max="1" step="0.01" value="0.28">
        </div>
      </div>
      <div class="row">
        <div class="left"><label>–ó–≤—É–∫–∏ (—ç—Ñ—Ñ–µ–∫—Ç—ã)</label></div>
        <div>
          <input type="checkbox" id="soundsToggle"> –í–∫–ª
        </div>
      </div>
      <div class="row">
        <div class="left"><label>–í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ</label></div>
        <div><input type="checkbox" id="vibrateToggle" checked></div>
      </div>
      <div class="row">
        <div class="left"><label>–¢–µ–º–∞</label></div>
        <div class="theme-options">
          <div class="theme-box" id="themeLight" style="background:linear-gradient(180deg,#fff9f3,#f0f4f8);color:#001">–°–≤–µ—Ç–ª–∞—è</div>
          <div class="theme-box" id="themeDark" style="background:linear-gradient(180deg,#0b1a2b,#061324);color:#cfe8ff">–¢—ë–º–Ω–∞—è</div>
          <div class="theme-box" id="themeRed" style="background:linear-gradient(180deg,#3b0f12,#20080a);color:#ffd1d1">–¢—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω–∞—è</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="closeSettings" class="inline-btn" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
(function(){
  // ----- –∫–æ–Ω—Ñ–∏–≥ -----
  const REEL_COUNT = 3;
  const SYMBOL_FILES = ['banana.png','star.png','gem.png','cherry.png','bell.png','lemon.png'].map(f => 'images/' + f);

  // –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∏–º–∞—Ü–∏–∏
  const TOTAL_SPIN_DURATION = 7000; // ms (–≤—Å–µ–≥–æ)
  const STRIP_REPEATS = 8;
  const MAX_MOTION_BLUR = 18;
  const BLUR_RAMP_START_MS = 200;
  const BLUR_RAMP_END_MS = 1000;
  const START_SLOW_FRAC = 0.12; // –∫–∞–∫ –ø—Ä–æ—Å–∏–ª
  const MAX_SCALE_BOOST = 1.28;
  const SCALE_EASE = 0.16;

  // ----- DOM & –∞—É–¥–∏–æ -----
  const reelArea = document.getElementById('reelArea');
  const canvas = document.getElementById('reelsCanvas');
  const ctx = canvas.getContext('2d', { alpha: true });
  const spinBtn = document.getElementById('spinBtn');
  const openSettings = document.getElementById('openSettings');
  const settingsModal = document.getElementById('settingsModal');
  const closeSettings = document.getElementById('closeSettings');
  const musicToggle = document.getElementById('musicToggle');
  const musicVolume = document.getElementById('musicVolume');
  const soundsToggle = document.getElementById('soundsToggle');
  const vibrateToggle = document.getElementById('vibrateToggle');
  const themeLight = document.getElementById('themeLight');
  const themeDark = document.getElementById('themeDark');
  const themeRed = document.getElementById('themeRed');
  const autoSpinBtn = document.getElementById('autoSpinBtn');
  const stakeInput = document.getElementById('stakeInput');

  const clickSound = document.getElementById('clickSound');
  const winSound = document.getElementById('winSound');
  const loseSound = document.getElementById('loseSound');
  const jackpotSound = document.getElementById('jackpotSound');
  const bgMusic = document.getElementById('bgMusic');

  try { clickSound.volume=0.28; winSound.volume=0.95; loseSound.volume=0.4; jackpotSound.volume=0.9; } catch(e){}

  // ----- layout -----
  let dpr = Math.max(1, window.devicePixelRatio || 1);
  let W=0,H=0,reelW=0,reelH=0,reelX=[];
  const PAD = 56;

  function computeLayout(){
    const rect = reelArea.getBoundingClientRect();
    W = Math.max(320, rect.width);
    H = Math.max(120, rect.height);
    const gap = Math.min(28, W * 0.02);
    reelW = Math.min(360, Math.max(96, Math.floor((W - gap*2) / 3)));
    reelH = Math.min(H * 0.96, reelW * 1.08, 460);
    const total = reelW * REEL_COUNT + gap * (REEL_COUNT - 1);
    const startX = (W - total) / 2;
    reelX = [];
    for (let i=0;i<REEL_COUNT;i++) reelX.push(Math.round(startX + i*(reelW + gap)));
  }

  function resize(){
    computeLayout();
    const canvasW = Math.round((W + PAD*2) * dpr);
    const canvasH = Math.round((H + PAD*2) * dpr);
    canvas.width = canvasW;
    canvas.height = canvasH;
    canvas.style.width = (W + PAD*2) + 'px';
    canvas.style.height = (H + PAD*2) + 'px';
    canvas.style.position = 'absolute';
    canvas.style.left = -PAD + 'px';
    canvas.style.top = -PAD + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);
  }
  window.addEventListener('resize', resize);

  // ----- preload symbols -----
  const SYMBOLS = [];
  for (let i=0;i<SYMBOL_FILES.length;i++){
    const img = new Image();
    img.src = SYMBOL_FILES[i];
    SYMBOLS.push({ img, name: SYMBOL_FILES[i].split('/').pop().split('.')[0] });
  }

  // ----- Reel model -----
  class Reel {
    constructor(i){
      this.i = i;
      this.strip = [];
      const base = [];
      for (let r=0; r<STRIP_REPEATS; r++){
        for (let s=0;s<SYMBOLS.length;s++) base.push(s);
      }
      for (let k=0;k<base.length;k++){
        const j = Math.floor(Math.random()*base.length);
        const tmp = base[k]; base[k]=base[j]; base[j]=tmp;
      }
      this.strip = base;
      this.offset = 0; this.startOffset = 0; this.targetOffset = 0;
      this.startTime = 0; this.duration = 0; this.spinning = false; this.onComplete = null;
      this.visualScale = 1.0;
    }
    start(finalSymbolIndex, duration){
      const symbolH = Math.round(reelH * 0.86);
      const rotations = 3 + Math.floor(Math.random()*2);
      let found = -1;
      for (let k = this.strip.length - 1; k >= 0; k--){
        if (this.strip[k] === finalSymbolIndex) { found = k; break; }
      }
      if (found === -1) found = Math.floor(Math.random()*this.strip.length);
      const targetPos = rotations * this.strip.length + found;
      this.startOffset = this.offset;
      this.targetOffset = - targetPos * symbolH;
      this.startTime = performance.now();
      this.duration = duration;
      this.spinning = true;
      this.onCompleteCalled = false;
    }
  }
  const reels = [];
  for (let i=0;i<REEL_COUNT;i++) reels.push(new Reel(i));

  function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || ''; }

  // easing: requested exponent 5
  function easeOutCubic(t){
    return 1 - Math.pow(1 - t, 5);
  }
  function smoothstep(t){ t = Math.max(0, Math.min(1, t)); return t * t * (3 - 2 * t); }

  // helpers
  function hexOrColorWithAlpha(c, a){
    if (/rgba?\(/.test(c)) {
      const inside = c.replace(/^rgba?\(|\)|\s/g,'').split(',');
      if (inside.length >= 3){
        return `rgba(${inside[0]},${inside[1]},${inside[2]},${a.toFixed(3)})`;
      }
    }
    if (/^#([0-9a-f]{3}|[0-9a-f]{6})/i.test(c)){
      let hex = c.replace('#','');
      if (hex.length === 3) hex = hex.split('').map(h=>h+h).join('');
      const r = parseInt(hex.substring(0,2),16);
      const g = parseInt(hex.substring(2,4),16);
      const b = parseInt(hex.substring(4,6),16);
      return `rgba(${r},${g},${b},${a.toFixed(3)})`;
    }
    return `rgba(140,170,223,${a.toFixed(3)})`;
  }
  function roundRectPath(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function roundRectStroke(ctx,x,y,w,h,r){ roundRectPath(ctx,x,y,w,h,r); ctx.stroke(); }

  // draw one reel (used for ordering so spinning reels drawn last)
  function drawSingleReel(obj){
    const r = obj.r, ri = obj.i;
    const symbolH = Math.round(reelH * 0.86);
    const offsetX = PAD;
    const centerY = PAD + H/2;
    const baseX = offsetX + reelX[ri];
    const baseY = centerY;
    const glowColorCss = cssVar('--glow-color') || 'rgba(140,170,223,0.46)';

    // update spin offset
    if (r.spinning){
      const now = performance.now();
      let tRaw = (now - r.startTime) / Math.max(1, r.duration);
      tRaw = Math.max(0, Math.min(1, tRaw));
      const delay = START_SLOW_FRAC;
      let tAdj = tRaw < delay ? 0 : (tRaw - delay) / (1 - delay);
      const eased = easeOutCubic(tAdj);
      r.offset = r.startOffset + (r.targetOffset - r.startOffset) * eased;
      if (tRaw >= 1 && !r.onCompleteCalled){
        r.spinning = false; r.onCompleteCalled = true;
        const totalH = symbolH * r.strip.length;
        r.offset = ((r.offset % totalH) + totalH) % totalH;
        if (typeof r.onComplete === 'function'){ r.onComplete(); r.onComplete = null; }
      }
    }

    // smooth scale value
    const targetScale = r.spinning ? MAX_SCALE_BOOST : 1.0;
    r.visualScale += (targetScale - r.visualScale) * SCALE_EASE;
    const scale = r.visualScale;

    // motion blur envelope
    let motionBlur = 0;
    if (r.spinning){
      const now = performance.now();
      const elapsed = Math.max(0, now - r.startTime);
      const dur = Math.max(1, r.duration);
      if (dur <= BLUR_RAMP_START_MS + BLUR_RAMP_END_MS){
        const norm = Math.min(1, Math.max(0, elapsed / dur));
        motionBlur = MAX_MOTION_BLUR * Math.sin(Math.PI * norm);
      } else {
        if (elapsed < BLUR_RAMP_START_MS) { motionBlur = 0; }
        else if (elapsed > dur - BLUR_RAMP_END_MS) {
          const rem = Math.max(0, dur - elapsed);
          const t = Math.max(0, Math.min(1, rem / BLUR_RAMP_END_MS));
          motionBlur = MAX_MOTION_BLUR * smoothstep(t);
        } else { motionBlur = MAX_MOTION_BLUR; }
      }
    }

    // DRAW STRONGER GLOW (shadow stroke) ‚Äî draw before reel so reel is on top
    if (r.spinning){
      const glowStrength = Math.max(0.02, (scale - 1) / (MAX_SCALE_BOOST - 1));
      const baseSize = Math.max(reelW, reelH);
      const glowRadius = baseSize * (0.45 + glowStrength * 0.32) * scale;
      ctx.save();
      ctx.translate(baseX + reelW/2, baseY);
      // **—É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ**
      ctx.shadowBlur = Math.max(12, glowRadius * 3);              // <- —Å–∏–ª—å–Ω–µ–µ blur
      ctx.shadowColor = hexOrColorWithAlpha(glowColorCss, 3);     // <- –±–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–∞—è –∞–ª—å—Ñ–∞
      ctx.strokeStyle = hexOrColorWithAlpha(glowColorCss, 0.02);
      ctx.lineWidth = Math.max(12, glowRadius * 0.34);               // <- —Ç–æ–ª—â–µ stroke —á—Ç–æ–±—ã glow –±—ã–ª –∑–∞–º–µ—Ç–Ω–µ–µ
      roundRectPath(ctx, -reelW/2, -reelH/2, reelW, reelH, 12);
      ctx.stroke();
      // reset
      ctx.shadowBlur = 0;
      ctx.shadowColor = 'transparent';
      ctx.restore();
    }

    // DRAW SCALED REEL + SYMBOLS + SCALED FRAME
    ctx.save();
    ctx.translate(baseX + reelW/2, baseY);
    ctx.scale(scale, scale);
    const localX = -reelW/2;
    const localY = -reelH/2;

    // clip
    roundRectPath(ctx, localX, localY, reelW, reelH, 12);
    ctx.clip();

    // interior
    const bgGrad = ctx.createLinearGradient(0, localY, 0, localY + reelH);
    bgGrad.addColorStop(0, cssVar('--bg-a') || '#031024');
    bgGrad.addColorStop(1, cssVar('--bg-b') || '#061c36');
    ctx.fillStyle = bgGrad;
    ctx.fillRect(localX, localY, reelW, reelH);

    // symbols
    const startSi = Math.floor(-r.offset / symbolH) - 4;
    const drawCount = 14;
    for (let si = startSi; si < startSi + drawCount; si++){
      const idx = ((si % r.strip.length) + r.strip.length) % r.strip.length;
      const symIndex = r.strip[idx];
      const sym = SYMBOLS[symIndex];
      if (!sym || !sym.img) continue;
      const yCenter = (si * symbolH) + r.offset;
      const topClip = localY - symbolH;
      const bottomClip = localY + reelH + symbolH;
      if (yCenter < topClip || yCenter > bottomClip) continue;

      const dist = Math.abs(yCenter - 0);
      const maxDist = reelH * 0.95;
      const progress = Math.max(0, 1 - dist / maxDist);
      const baseScale = 0.70 + 0.30 * progress;
      const symScale = baseScale;
      const brightness = 0.96 + 0.04 * progress;
      const alpha = 0.56 + 0.44 * progress;

      const drawW = reelW * 0.78 * symScale;
      const drawH = symbolH * 0.86 * symScale;
      const drawX = localX + (reelW - drawW)/2;
      const drawY = yCenter - drawH/2;

      if (motionBlur > 0.6){
        const samples = Math.min(6, Math.max(3, Math.round(motionBlur / 3)));
        for (let s = 0; s < samples; s++){
          const t = samples === 1 ? 0.5 : s / (samples - 1);
          const offsetY = (t - 0.5) * motionBlur * 1.2;
          const alphaMul = (1 - Math.abs(t - 0.5) * 1.8) * alpha;
          ctx.save();
          ctx.globalAlpha = Math.max(0, Math.min(1, alphaMul * 0.92));
          ctx.filter = `brightness(${brightness.toFixed(3)})`;
          try { ctx.drawImage(sym.img, drawX, drawY + offsetY, drawW, drawH); } catch(e){}
          ctx.restore();
        }
      } else {
        ctx.save();
        ctx.globalAlpha = Math.min(1, Math.max(0.12, alpha));
        ctx.filter = `brightness(${brightness.toFixed(3)})`;
        try { ctx.drawImage(sym.img, drawX, drawY, drawW, drawH); } catch(e){}
        ctx.restore();
      }
    }

    // scaled frame (scales with reel)
    ctx.save();
    ctx.lineWidth = 2.2;
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    roundRectStroke(ctx, localX, localY, reelW, reelH, 12);
    ctx.restore();

    ctx.restore(); // end scaled reel
  }

  // main draw loop: draw non-spinning first, spinning last (spinning on top)
  function draw(){
    ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);

    const enumerated = reels.map((r,i)=>({r,i}));
    const nonSpinning = enumerated.filter(o => !o.r.spinning);
    const spinning = enumerated.filter(o => o.r.spinning);

    for (const obj of nonSpinning) drawSingleReel(obj);
    for (const obj of spinning) drawSingleReel(obj);

    requestAnimationFrame(draw);
  }

  // ----- probabilities -----
  function generateResult(){
    const chance = Math.random()*100;
    if (chance < 1.5){ const s = Math.floor(Math.random()*SYMBOLS.length); return [s,s,s]; }
    else if (chance < 36.5){
      const s1 = Math.floor(Math.random()*SYMBOLS.length);
      let s2; do { s2 = Math.floor(Math.random()*SYMBOLS.length); } while (s2 === s1);
      if (Math.random() < 0.5) return [s1,s1,s2]; else return [s1,s2,s1];
    } else {
      const arr = [];
      while (arr.length < 3){
        const s = Math.floor(Math.random()*SYMBOLS.length);
        if (!arr.includes(s)) arr.push(s);
      }
      return arr;
    }
  }

  // ----- spin orchestration -----
  let spinningFlag = false, autoSpin=false, autoSpinTimer=null;
  const SETTINGS_KEY = 'rc_settings_vfinal';
  let settings = { theme:'dark', musicEnabled:false, musicVolume:0.28, soundsEnabled:true, vibrationEnabled:true, autoSpin:false };

  async function doSpin(){
    if (spinningFlag) return;
    const stake = Math.max(10, Math.floor(Number(stakeInput.value) || 100));
    if (stake <= 0){ setMessage('–ü–æ—Å—Ç–∞–≤—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É',2000); return; }
    if (currentBalance < stake){ setMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!',2000); return; }
    stakeInput.value = stake;

    spinningFlag = true;
    spinBtn.disabled = true;
    spinBtn.classList.remove('breathing');
    setMessage('');
    currentBalance -= stake;
    document.getElementById('balValue').textContent = currentBalance;
    saveBalance();

    const finals = generateResult();

    if (window.Telegram && Telegram.WebApp){
      try{ Telegram.WebApp.sendData(JSON.stringify({ action:'start_game' })); }catch(e){}
    }

    const baseDur = Math.floor(TOTAL_SPIN_DURATION / REEL_COUNT);
    const durations = [baseDur, baseDur, TOTAL_SPIN_DURATION - baseDur*2];

    for (let i=0;i<REEL_COUNT;i++){
      const r = reels[i];
      const dur = durations[i];
      r.start(finals[i], dur);
      await new Promise(resolve => {
        r.onComplete = () => {
          try{ if (settings.soundsEnabled) { clickSound.currentTime=0; clickSound.play().catch(()=>{}); } } catch(e){}
          resolve();
        };
      });
      await new Promise(res => setTimeout(res, 120));
    }

    const names = reels.map(r => {
      const symbolH = Math.round(reelH * 0.86);
      const centerIndexFloat = - Math.round(r.offset / symbolH);
      const idx = ((centerIndexFloat % r.strip.length) + r.strip.length) % r.strip.length;
      return SYMBOLS[r.strip[idx]].name;
    });

    const stakeUsed = Math.max(10, Math.floor(Number(stakeInput.value) || 100));
    let change = 0, msg = '';
    const allEqual = names.every(v => v === names[0]);
    const anyPair = (names[0] === names[1]) || (names[1] === names[2]) || (names[0] === names[2]);
    if (allEqual){
      if (names[0] === 'gem'){ change = stakeUsed * 10; msg = 'üéâ JACKPOT!'; if (settings.soundsEnabled) playSafe(jackpotSound); }
      else { change = stakeUsed * 8; msg = 'üî• –ë–æ–ª—å—à–æ–π –≤—ã–∏–≥—Ä—ã—à!'; if (settings.soundsEnabled) playSafe(winSound); }
    } else if (anyPair){ change = stakeUsed * 2; msg = 'üòâ –ü–æ—á—Ç–∏ ‚Äî –º–µ–ª–∫–∏–π –≤—ã–∏–≥—Ä—ã—à'; if (settings.soundsEnabled) playSafe(winSound); }
    else { change = 0; msg = 'üôÅ –£–≤—ã ‚Äî –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë'; if (settings.soundsEnabled) playSafe(loseSound); }

    if (change > 0 && settings.vibrationEnabled){
      try { if (navigator.vibrate) { if (change >= stakeUsed * 8) navigator.vibrate([70,40,70,80]); else navigator.vibrate([40,20,40]); } } catch(e){}
    }

    if (change > 0) smoothWinGradient();
    currentBalance += change;
    document.getElementById('balValue').textContent = currentBalance;
    saveBalance();
    setMessage(msg,2400);

    if (window.Telegram && Telegram.WebApp){
      try { Telegram.WebApp.sendData(JSON.stringify({ action:'slot_result', result: names.join(','), change: (change - stakeUsed) })); } catch(e){}
    }

    spinningFlag = false;
    spinBtn.disabled = false;
    spinBtn.classList.add('breathing');

    if (autoSpin){
      autoSpinTimer = setTimeout(()=> { if (!spinningFlag) doSpin(); }, 700);
    }
  }

  // ----- settings/UI -----
  function loadSettings(){
    try { const raw = localStorage.getItem(SETTINGS_KEY); if (raw) settings = Object.assign(settings, JSON.parse(raw)); } catch(e){}
    applySettingsToUI(); applySettingsEffect();
  }
  function saveSettings(){ try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); } catch(e){} }
  function applySettingsToUI(){
    musicToggle.checked = !!settings.musicEnabled;
    musicVolume.value = settings.musicVolume ?? 0.28;
    soundsToggle.checked = !!settings.soundsEnabled;
    vibrateToggle.checked = !!settings.vibrationEnabled;
    [themeLight, themeDark, themeRed].forEach(el => el.style.outline = 'none');
    if (settings.theme === 'light') themeLight.style.outline = '3px solid rgba(255,255,255,0.12)';
    else if (settings.theme === 'red') themeRed.style.outline = '3px solid rgba(255,255,255,0.12)';
    else themeDark.style.outline = '3px solid rgba(255,255,255,0.12)';
    autoSpin = !!settings.autoSpin;
    autoSpinBtn.textContent = autoSpin ? 'Auto: On' : 'Auto: Off';
  }
  function applySettingsEffect(){
    if (settings.musicEnabled){ try { bgMusic.volume = settings.musicVolume; bgMusic.play().catch(()=>{}); } catch(e){} } else { try { bgMusic.pause(); } catch(e){} }
    if (settings.soundsEnabled){ try { clickSound.volume = 0.28; winSound.volume = 0.95; loseSound.volume = 0.4; jackpotSound.volume = 0.9; } catch(e){} } else { try { clickSound.volume = 0; winSound.volume = 0; loseSound.volume = 0; jackpotSound.volume = 0; } catch(e){} }
    applyTheme(settings.theme);
    saveSettings();
  }
  function applyTheme(theme){
    if (theme === 'light'){
      document.documentElement.style.setProperty('--bg-a', '#f6f8fb');
      document.documentElement.style.setProperty('--bg-b', '#ffffff');
      document.documentElement.style.setProperty('--text', '#0b1722');
      document.documentElement.style.setProperty('--panel-bg', 'rgba(255,255,255,0.96)');
      document.documentElement.style.setProperty('--btn-a', '#f3cfa8');
      document.documentElement.style.setProperty('--btn-b', '#d1a27a');
      document.documentElement.style.setProperty('--glow-color', 'rgba(200,170,130,0.56)');
      document.documentElement.style.setProperty('--win-a', 'rgba(255,230,200,0.98)');
      document.documentElement.style.setProperty('--win-b', 'rgba(255,245,240,0.96)');
      document.documentElement.style.setProperty('--modal-a', '#ffffff');
      document.documentElement.style.setProperty('--modal-b', '#fbfbfb');
    } else if (theme === 'red'){
      document.documentElement.style.setProperty('--bg-a', '#10060a');
      document.documentElement.style.setProperty('--bg-b', '#2b0c0f');
      document.documentElement.style.setProperty('--text', '#ffdede');
      document.documentElement.style.setProperty('--panel-bg', 'rgba(40,10,12,0.7)');
      document.documentElement.style.setProperty('--btn-a', '#e06a66');
      document.documentElement.style.setProperty('--btn-b', '#8b2f2f');
      document.documentElement.style.setProperty('--glow-color', 'rgba(220,80,90,0.56)');
      document.documentElement.style.setProperty('--win-a', 'rgba(120,20,28,0.98)');
      document.documentElement.style.setProperty('--win-b', 'rgba(40,8,10,0.96)');
      document.documentElement.style.setProperty('--modal-a', '#2b0c0f');
      document.documentElement.style.setProperty('--modal-b', '#150405');
    } else {
      document.documentElement.style.setProperty('--bg-a', '#031024');
      document.documentElement.style.setProperty('--bg-b', '#061c36');
      document.documentElement.style.setProperty('--text', '#cfe8ff');
      document.documentElement.style.setProperty('--panel-bg', 'rgba(3,16,28,0.52)');
      document.documentElement.style.setProperty('--btn-a', '#91b7e7');
      document.documentElement.style.setProperty('--btn-b', '#2b5f91');
      document.documentElement.style.setProperty('--glow-color', 'rgba(140,170,223,0.46)');
      document.documentElement.style.setProperty('--win-a', 'rgba(28,60,100,0.98)');
      document.documentElement.style.setProperty('--win-b', 'rgba(6,20,34,0.96)');
      document.documentElement.style.setProperty('--modal-a', 'rgba(6,12,22,0.98)');
      document.documentElement.style.setProperty('--modal-b', 'rgba(8,18,32,0.98)');
    }
    spinBtn.style.background = `linear-gradient(180deg, ${cssVar('--btn-a')}, ${cssVar('--btn-b')})`;
    openSettings.style.background = spinBtn.style.background;
    const modalPanel = document.querySelector('.modal-panel');
    if (modalPanel) modalPanel.style.background = `linear-gradient(180deg, ${cssVar('--modal-a')}, ${cssVar('--modal-b')})`;
  }

  // ----- UI wiring -----
  openSettings.addEventListener('click', ()=> { settingsModal.style.display = 'flex'; });
  closeSettings.addEventListener('click', ()=> { settingsModal.style.display = 'none'; applySettingsEffect(); });
  musicToggle.addEventListener('change', (e)=> { settings.musicEnabled = e.target.checked; applySettingsEffect(); });
  musicVolume.addEventListener('input', (e)=> { settings.musicVolume = Number(e.target.value); applySettingsEffect(); saveSettings(); });
  soundsToggle.addEventListener('change', (e)=> { settings.soundsEnabled = e.target.checked; applySettingsEffect(); saveSettings(); });
  vibrateToggle.addEventListener('change', (e)=> { settings.vibrationEnabled = e.target.checked; saveSettings(); });

  themeLight.addEventListener('click', ()=> { settings.theme='light'; applySettingsToUI(); applySettingsEffect(); });
  themeDark.addEventListener('click', ()=> { settings.theme='dark'; applySettingsToUI(); applySettingsEffect(); });
  themeRed.addEventListener('click', ()=> { settings.theme='red'; applySettingsToUI(); applySettingsEffect(); });

  // robust handling –∫–Ω–æ–ø–æ–∫ —Å—Ç–∞–≤–æ–∫ ‚Äî –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ canvas –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç)
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-step]');
    if (!btn) return;
    // —Ö–æ—Ç–∏–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –∏–∑ quick-stakes –∏–ª–∏ button —Å id maxStakeBtn
    if (!btn.closest('.quick-stakes') && btn.id !== 'maxStakeBtn') return;
    const ds = String(btn.getAttribute('data-step') || '');
    if (!ds) return;
    if (ds === 'max') {
      stakeInput.value = Math.max(10, currentBalance);
      return;
    }
    const parsed = parseInt(ds, 10);
    if (!isNaN(parsed)){
      const cur = Math.max(10, Math.floor(Number(stakeInput.value) || 100));
      let val = cur + parsed;
      // if user pressed -100/-50, ensure minimum 10
      stakeInput.value = Math.max(10, val);
    }
  });

  document.getElementById('maxStakeBtn').addEventListener('click', ()=> { stakeInput.value = Math.max(10, currentBalance); });
  stakeInput.addEventListener('blur', ()=> { stakeInput.value = Math.max(10, Math.floor(Number(stakeInput.value) || 100)); });

  autoSpinBtn.addEventListener('click', ()=> {
    autoSpin = !autoSpin;
    settings.autoSpin = autoSpin;
    saveSettings();
    autoSpinBtn.textContent = autoSpin ? 'Auto: On' : 'Auto: Off';
    if (!autoSpin && autoSpinTimer) { clearTimeout(autoSpinTimer); autoSpinTimer = null; }
    if (autoSpin && !spinningFlag) doSpin();
  });

  spinBtn.addEventListener('click', ()=> {
    doSpin().catch(e=>{ console.error(e); spinBtn.disabled=false; spinningFlag=false; updateBreathing(); });
    updateBreathing();
  });

  function updateBreathing(){ if (!spinningFlag && !spinBtn.disabled) spinBtn.classList.add('breathing'); else spinBtn.classList.remove('breathing'); }

  // ----- balance -----
  const BAL_KEY = 'rc_balance_vfinal';
  let currentBalance = parseInt(localStorage.getItem(BAL_KEY)) || 1000;
  document.getElementById('balValue').textContent = currentBalance;
  function saveBalance(){ localStorage.setItem(BAL_KEY, String(currentBalance)); }

  function playSafe(audio){ try{ audio.currentTime = 0; audio.play().catch(()=>{}); }catch(e){} }
  function setMessage(text, timeout=2200){ const m = document.getElementById('message'); m.textContent = text; if (timeout>0) setTimeout(()=>{ m.textContent = '–ì–æ—Ç–æ–≤–æ ‚Äî –Ω–∞–∂–º–∏ SPIN'; }, timeout); }
  function smoothWinGradient(){
    const a = cssVar('--win-a') || 'rgba(28,60,100,0.98)';
    const b = cssVar('--win-b') || 'rgba(6,20,34,0.96)';
    document.body.style.transition = 'background 900ms ease-in-out';
    document.body.style.background = `linear-gradient(180deg, ${a}, ${b})`;
    setTimeout(()=> { document.body.style.background = ''; setTimeout(()=>{ document.body.style.transition=''; },900); }, 900);
  }

  // ----- init -----
  resize();
  loadSettings();
  requestAnimationFrame(draw);
  updateBreathing();
  const ro = new ResizeObserver(()=> { resize(); });
  ro.observe(reelArea);

  if (window.Telegram && Telegram.WebApp){
    try{ Telegram.WebApp.ready(); Telegram.WebApp.sendData(JSON.stringify({ action: "start_game" })); }catch(e){}
  }

  window.addEventListener('beforeunload', ()=> { saveSettings(); saveBalance(); });
  window._rc = { reels, SYMBOLS, settings };

})();
</script>
</body>
</html>

